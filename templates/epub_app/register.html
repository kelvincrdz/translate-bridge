{% extends 'base.html' %}

{% block title %}Registrar - Tradutor EPUB{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-background px-4 py-8">
    <div class="w-full max-w-md stack-lg">
        <!-- Header -->
        <header class="stack-md text-center">
            <div class="flex justify-between items-center mb-2">
                <div class="flex justify-center w-full relative">
                    <div class="p-3 bg-primary rounded-full shadow-sm">
                        <i data-lucide="user-plus" class="icon-6 text-primary-foreground"></i>
                    </div>
                    <button class="icon-btn absolute right-0 top-0" data-theme-toggle aria-label="Alternar tema">
                        <i data-lucide="sun" class="icon-5 theme-icon-sun"></i>
                        <i data-lucide="moon" class="icon-5 theme-icon-moon hidden"></i>
                    </button>
                </div>
            </div>
            <div class="stack-md">
                <h1 class="text-2xl font-semibold tracking-tight">Criar Conta</h1>
                <p class="text-sm text-muted-foreground">Cadastre-se para gerenciar e traduzir seus EPUBs</p>
            </div>
        </header>

        <!-- Register Form -->
        <div class="card">
            <div class="card-content">
                <form method="post" class="stack-md" id="register-form">
                    {% csrf_token %}

                    <!-- Username -->
                    <div class="stack-sm">
                        <label for="id_username" class="label">Usuário</label>
                        <input type="text" name="username" maxlength="150" autofocus required id="id_username" class="input w-full" placeholder="Seu nome de usuário">
                        <div class="text-sm text-destructive hidden" id="username-error"></div>
                    </div>

                    <!-- Full Name -->
                    <div class="stack-sm">
                        <label for="id_full_name" class="label">Nome completo (opcional)</label>
                        <input type="text" name="full_name" id="id_full_name" class="input w-full" placeholder="Seu nome completo">
                        <div class="text-sm text-destructive hidden" id="full_name-error"></div>
                    </div>

                    <!-- Email -->
                    <div class="stack-sm">
                        <label for="id_email" class="label">Email</label>
                        <input type="email" name="email" required id="id_email" class="input w-full" placeholder="voce@exemplo.com">
                        <div class="text-sm text-destructive hidden" id="email-error"></div>
                    </div>

                    <!-- Password1 -->
                    <div class="stack-sm">
                        <label for="id_password1" class="label">Senha</label>
                        <div class="relative">
                            <input type="password" name="password1" autocomplete="new-password" required id="id_password1" class="input w-full pr-10" placeholder="Crie uma senha">
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-muted-foreground hover:text-foreground" onclick="togglePassword('id_password1','password1-icon')">
                                <i data-lucide="eye" class="h-4 w-4" id="password1-icon"></i>
                            </button>
                        </div>
                        <div class="text-xs text-muted-foreground">Use pelo menos 8 caracteres.</div>
                        <div class="text-sm text-destructive hidden" id="password1-error"></div>
                    </div>

                    <!-- Password2 -->
                    <div class="stack-sm">
                        <label for="id_password2" class="label">Confirmar Senha</label>
                        <div class="relative">
                            <input type="password" name="password2" autocomplete="new-password" required id="id_password2" class="input w-full pr-10" placeholder="Repita a senha">
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-muted-foreground hover:text-foreground" onclick="togglePassword('id_password2','password2-icon')">
                                <i data-lucide="eye" class="h-4 w-4" id="password2-icon"></i>
                            </button>
                        </div>
                        <div class="text-sm text-destructive hidden" id="password2-error"></div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-full" id="register-button">
                        <span id="register-text">Criar conta</span>
                        <div class="hidden" id="register-spinner">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        </div>
                    </button>

                    <!-- Non field errors -->
                    {% if form.non_field_errors %}
                        <div class="text-sm text-destructive text-center">
                            {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Footer Links -->
    <div class="text-center stack-sm">
            <p class="text-sm text-muted-foreground">
                Já tem uma conta?
                <a href="{% url 'login' %}" class="text-primary hover:text-primary/80 font-medium">Entrar</a>
            </p>
        </div>

        <!-- Toggle movido para header -->
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function togglePassword(fieldId, iconId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(iconId);
    if (field.type === 'password') {
        field.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
    } else {
        field.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
    }
    lucide.createIcons();
}

// Submit via AJAX
const form = document.getElementById('register-form');
form.addEventListener('submit', async function(e){
    e.preventDefault();
    const button = document.getElementById('register-button');
    const text = document.getElementById('register-text');
    const spinner = document.getElementById('register-spinner');

    button.disabled = true;
    text.classList.add('hidden');
    spinner.classList.remove('hidden');

    // Clear previous errors
    ['username','full_name','email','password1','password2'].forEach(f => {
        const el = document.getElementById(`${f}-error`);
        if (el) { el.classList.add('hidden'); el.textContent=''; }
    });

    try {
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((value, key) => payload[key] = value);

        const response = await Utils.fetchWithCSRF('{% url "register" %}', {
            method: 'POST',
            body: JSON.stringify(payload),
            noThrow: true
        });

        const data = await response.json().catch(()=>({success:false}));

        if (!response.ok || !data.success) {
            if (data.errors) {
                Object.entries(data.errors).forEach(([field, errors]) => {
                    const errorElement = document.getElementById(`${field}-error`);
                    if (errorElement) {
                        errorElement.textContent = errors[0];
                        errorElement.classList.remove('hidden');
                    }
                });
            }
            toast.error(data.message || 'Erro ao registrar.');
        } else {
            toast.success('Conta criada com sucesso! Redirecionando...');
            setTimeout(()=> window.location.href = (data.redirect_url || "{% url 'library' %}"), 800);
        }
    } catch(err) {
        console.error(err);
        toast.error('Erro inesperado.');
    } finally {
        button.disabled = false;
        text.classList.remove('hidden');
        spinner.classList.add('hidden');
    }
});

// Autofocus username
window.addEventListener('DOMContentLoaded', ()=> document.getElementById('id_username').focus());
</script>
{% endblock %}
